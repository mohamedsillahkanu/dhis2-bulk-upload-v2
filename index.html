<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DHIS2 Bulk Upload â€” ICF-SL</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#f0f4f8;font-family:'Oswald',sans-serif;color:#000;font-weight:500;min-height:100vh;}

/* LOGIN */
.login-screen{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#004080,#0066cc);}
.login-card{background:#fff;border-radius:12px;padding:38px;max-width:460px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.25);border:4px double #004080;}
.lc-logo{display:flex;justify-content:center;margin-bottom:20px;}
.logo-box{background:#f8f9fa;border-radius:8px;padding:10px;border:2px solid #004080;display:inline-block;}
.logo-box img{width:90px;display:block;border-radius:5px;}
.lc-title{text-align:center;margin-bottom:26px;}
.lc-title h1{color:#004080;font-size:20px;font-weight:700;letter-spacing:1px;margin-bottom:4px;}
.lc-title p{color:#666;font-size:12px;}
.fg{margin-bottom:16px;}
.fl{display:block;color:#004080;font-size:11px;font-weight:700;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.fi{width:100%;padding:11px 14px;border:2px solid #004080;border-radius:6px;font-size:13px;font-family:'Oswald',sans-serif;font-weight:500;color:#000;background:#fff;transition:all .2s;}
.fi:focus{outline:none;border-color:#0056b3;box-shadow:0 0 0 3px rgba(0,64,128,.12);}
.fi::placeholder{color:#bbb;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.btn-login{width:100%;padding:13px;background:#004080;color:#fff;border:2px solid #004080;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;text-transform:uppercase;font-family:'Oswald',sans-serif;transition:all .2s;margin-top:4px;}
.btn-login:hover{background:#0056b3;}
.btn-login:disabled{background:#6c757d;border-color:#6c757d;cursor:wait;}

/* MAIN */
.main{display:none;padding:18px;}
.main.active{display:block;}
.wrap{max-width:1200px;margin:0 auto;}

/* HEADER */
.page-hdr{background:#004080;color:#fff;padding:22px 28px;text-align:center;border-radius:8px 8px 0 0;}
.page-hdr .logo-box{background:#fff;border:none;}
.page-hdr h3{font-size:12px;font-weight:700;letter-spacing:1px;margin:10px 0 3px;}
.page-hdr .tag{font-size:10px;margin-bottom:10px;font-style:italic;}
.page-hdr h1{font-size:22px;font-weight:700;letter-spacing:1px;margin-bottom:5px;}
.page-hdr .sub{font-size:12px;}

/* CARD */
.card{border:4px double #004080;border-top:none;border-radius:0 0 12px 12px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:14px;}
.card-inner{padding:26px;}

/* SECTION HEADER */
.sec-hdr{background:#004080;color:#fff;padding:12px 16px;margin-bottom:16px;border-radius:6px;display:flex;align-items:center;gap:11px;}
.sec-num{background:#fff;color:#004080;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;}
.sec-ttl{font-size:14px;font-weight:700;letter-spacing:.5px;}

/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap;}
.tab{padding:9px 16px;background:#e9ecef;border:2px solid #dee2e6;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Oswald',sans-serif;color:#888;display:flex;align-items:center;gap:6px;transition:all .2s;}
.tab.active{background:#004080;color:#fff;border-color:#004080;}
.tab.done{background:#d4edda;color:#155724;border-color:#28a745;}
.tab .tn{width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.tab.done .tn{background:#28a745;color:#fff;}
.panel{display:none;}
.panel.active{display:block;}

/* CONFIG GRID */
.cfg-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.cfg-box{background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:16px;}
.cfg-box label{display:block;color:#004080;font-size:11px;font-weight:700;margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px;}
.cfg-box select{width:100%;padding:10px 12px;border:2px solid #004080;border-radius:6px;font-size:13px;font-family:'Oswald',sans-serif;font-weight:500;}
.cfg-hint{font-size:11px;color:#666;margin-top:6px;line-height:1.5;}

/* STATS */
.stats{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0;}
.stat{flex:1;min-width:110px;background:#f8f9fa;border:2px solid #dee2e6;border-radius:8px;padding:12px;text-align:center;}
.stat.blue{border-color:#004080;background:#e7f3ff;}
.stat.green{border-color:#28a745;background:#d4edda;}
.stat.red{border-color:#dc3545;background:#f8d7da;}
.stat.gold{border-color:#ffc107;background:#fff3cd;}
.stat-n{font-size:28px;font-weight:700;color:#004080;line-height:1;}
.stat.green .stat-n{color:#155724;}
.stat.red .stat-n{color:#721c24;}
.stat.gold .stat-n{color:#856404;}
.stat-l{font-size:10px;color:#666;margin-top:4px;text-transform:uppercase;letter-spacing:.4px;}

/* DROP ZONE */
.dz{border:3px dashed #004080;border-radius:10px;padding:42px 22px;text-align:center;background:#f0f7ff;cursor:pointer;transition:all .25s;position:relative;}
.dz:hover,.dz.over{background:#d9ecff;}
.dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-ico{font-size:52px;margin-bottom:10px;}
.dz-ttl{font-size:18px;font-weight:700;color:#004080;margin-bottom:6px;}
.dz-sub{font-size:12px;color:#777;}
.file-badge{display:inline-flex;align-items:center;gap:10px;background:#d4edda;border:2px solid #28a745;border-radius:8px;padding:9px 16px;margin-top:13px;font-size:13px;font-weight:600;color:#155724;}
.rm-btn{background:#dc3545;color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* INFO BOXES */
.info-box{padding:11px 16px;border-radius:6px;margin:10px 0;font-size:12px;line-height:1.7;}
.info-box.blue{background:#e7f3ff;border:2px solid #004080;color:#004080;}
.info-box.green{background:#d4edda;border:2px solid #28a745;color:#155724;}
.info-box.yellow{background:#fff3cd;border:2px solid #ffc107;color:#856404;}
.info-box.red{background:#f8d7da;border:2px solid #dc3545;color:#721c24;}

/* TABLES */
.tbl-wrap{overflow-x:auto;max-height:260px;overflow-y:auto;border:2px solid #004080;border-radius:8px;margin:10px 0;}
.tbl{width:100%;border-collapse:collapse;font-size:12px;}
.tbl th{background:#004080;color:#fff;padding:9px 12px;text-align:left;position:sticky;top:0;font-weight:600;white-space:nowrap;}
.tbl td{padding:7px 12px;border-bottom:1px solid #e9ecef;white-space:nowrap;}
.tbl tr:nth-child(even) td{background:#f8f9fa;}
.tbl tr:hover td{background:#e7f3ff;}
.badge{display:inline-block;padding:2px 9px;border-radius:10px;font-size:10px;font-weight:700;}
.badge.ok{background:#28a745;color:#fff;}
.badge.skip{background:#aaa;color:#fff;}
.badge.warn{background:#ffc107;color:#000;}
.val-ok{color:#155724;font-weight:600;}
.val-empty{color:#ccc;}

/* PROGRESS */
.prog-wrap{display:none;background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:16px;margin:16px 0;}
.prog-wrap.active{display:block;}
.prog-top{display:flex;justify-content:space-between;margin-bottom:4px;}
.prog-bar{height:26px;background:#e9ecef;border-radius:6px;overflow:hidden;border:2px solid #004080;margin:8px 0;}
.prog-fill{height:100%;background:linear-gradient(90deg,#004080,#0066cc);transition:width .3s;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;min-width:35px;}
.log-box{margin-top:12px;max-height:230px;overflow-y:auto;background:#1a1a2e;border-radius:6px;padding:12px 14px;font-family:'Courier New',monospace;font-size:12px;}
.log-line{padding:3px 0;}
.log-line.info{color:#17a2b8;}
.log-line.success{color:#28a745;}
.log-line.error{color:#dc3545;}
.log-line.warning{color:#ffc107;}

/* BUTTONS */
.btn{padding:11px 22px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Oswald',sans-serif;transition:all .2s;border:2px solid;}
.btn-blue{background:#004080;color:#fff;border-color:#004080;}
.btn-blue:hover{background:#0056b3;}
.btn-blue:disabled{background:#6c757d;border-color:#6c757d;cursor:wait;}
.btn-gold{background:#ffc107;color:#000;border-color:#ffc107;}
.btn-gold:hover{background:#e0a800;}
.btn-gold:disabled{background:#e9ecef;color:#888;border-color:#ccc;cursor:wait;}
.btn-green{background:#28a745;color:#fff;border-color:#28a745;}
.btn-green:hover{background:#218838;}
.btn-green:disabled{background:#6c757d;border-color:#6c757d;cursor:wait;}
.btn-outline{background:#fff;color:#004080;border-color:#004080;}
.btn-outline:hover{background:#004080;color:#fff;}
.btn-outline-red{background:#fff;color:#dc3545;border-color:#dc3545;}
.btn-outline-red:hover{background:#dc3545;color:#fff;}
.btn-lg{padding:14px 44px;font-size:15px;}
.btn-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;}

/* TOGGLE */
.tog-row{display:flex;align-items:center;gap:9px;padding:7px 0;}
.tog-row input[type=checkbox]{width:17px;height:17px;accent-color:#004080;cursor:pointer;}
.tog-row label{font-size:13px;cursor:pointer;}

/* NOTIFICATION */
.notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 26px;border-radius:8px;font-weight:600;z-index:9999;display:none;box-shadow:0 4px 14px rgba(0,0,0,.2);min-width:250px;text-align:center;font-size:13px;}
.notif.success{background:#d4edda;color:#155724;border:2px solid #28a745;display:block;}
.notif.error{background:#f8d7da;color:#721c24;border:2px solid #dc3545;display:block;}
.notif.info{background:#e7f3ff;color:#004080;border:2px solid #004080;display:block;}
.notif.warning{background:#fff3cd;color:#856404;border:2px solid #ffc107;display:block;}

/* FOOTER */
.footer{background:#004080;color:#fff;padding:16px;text-align:center;font-size:12px;line-height:1.8;border-radius:0 0 8px 8px;}

::-webkit-scrollbar{width:7px;height:7px;}
::-webkit-scrollbar-thumb{background:#004080;border-radius:4px;}
::-webkit-scrollbar-track{background:#f0f4f8;}

@media(max-width:700px){
  .cfg-grid,.fr{grid-template-columns:1fr;}
  .stats{gap:6px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â• LOGIN â•â•â•â•â•â• -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="lc-logo">
      <div class="logo-box">
        <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
      </div>
    </div>
    <div class="lc-title">
      <h1>DHIS2 BULK DATASET UPLOAD</h1>
      <p>ICF-SL Â· Push Excel data directly into DHIS2</p>
    </div>
    <form id="loginForm">
      <div class="fg">
        <label class="fl">DHIS2 Instance URL</label>
        <input type="url" class="fi" id="instanceUrl" placeholder="https://sl.dhis2.org/hmis23" required>
      </div>
      <div class="fr">
        <div class="fg">
          <label class="fl">Username</label>
          <input type="text" class="fi" id="username" placeholder="admin" required>
        </div>
        <div class="fg">
          <label class="fl">Password</label>
          <input type="password" class="fi" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
      </div>
      <button type="submit" class="btn-login" id="loginBtn">ğŸ”— Connect to DHIS2</button>
    </form>
  </div>
</div>

<!-- â•â•â•â•â•â• MAIN â•â•â•â•â•â• -->
<div class="main" id="mainDiv">
  <div class="wrap">

    <div class="page-hdr">
      <div class="lc-logo">
        <div class="logo-box">
          <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" style="width:80px;">
        </div>
      </div>
      <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
      <p class="tag">Driving Data-Driven Solutions for Health and Development</p>
      <h1>ğŸ“¤ DHIS2 BULK DATASET UPLOAD</h1>
      <p class="sub">Select dataset Â· Select org unit level Â· Upload Excel Â· Auto-match Â· Push to DHIS2</p>
    </div>

    <div class="card">
      <div class="card-inner">

        <!-- STEP TABS -->
        <div class="tabs">
          <div class="tab active" id="tab1" onclick="goStep(1)"><span class="tn">1</span>Configure</div>
          <div class="tab" id="tab2" onclick="goStep(2)"><span class="tn">2</span>Upload Excel</div>
          <div class="tab" id="tab3" onclick="goStep(3)"><span class="tn">3</span>Review</div>
          <div class="tab" id="tab4" onclick="goStep(4)"><span class="tn">4</span>Push to DHIS2</div>
        </div>

        <!-- â•â•â•â•â•â• STEP 1: CONFIGURE â•â•â•â•â•â• -->
        <div class="panel active" id="panel1">
          <div class="sec-hdr">
            <span class="sec-num">1</span>
            <span class="sec-ttl">SELECT DATASET &amp; ORG UNIT LEVEL</span>
          </div>

          <div class="info-box blue">
            First load all datasets and org unit levels from your DHIS2.
            Then select the <strong>target dataset</strong> and the <strong>org unit level</strong> where your data is collected.
            Org unit names will be automatically matched from your Excel file.
          </div>

          <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:18px;">
            <button class="btn btn-blue" id="loadMetaBtn" onclick="loadMeta()">ğŸ”„ Load Datasets &amp; Org Unit Levels</button>
            <span id="metaStatus" style="font-size:13px;color:#666;"></span>
          </div>

          <div class="cfg-grid">
            <div class="cfg-box">
              <label>Target Dataset</label>
              <select id="dsSel" onchange="onDatasetChange()">
                <option value="">-- load metadata first --</option>
              </select>
              <div class="cfg-hint" id="dsHint" style="display:none;"></div>
            </div>
            <div class="cfg-box">
              <label>Org Unit Level</label>
              <select id="lvlSel" onchange="onLevelChange()">
                <option value="">-- load metadata first --</option>
              </select>
              <div class="cfg-hint">
                Select the level where your health facilities or data collectors are.
                Then click <strong>Load Org Units</strong> below.
              </div>
            </div>
          </div>

          <div id="ouLoadRow" style="display:none;margin-bottom:18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
            <button class="btn btn-blue" id="ouBtn" onclick="loadOrgUnits()">ğŸ“ Load Org Units at Selected Level</button>
            <span id="ouStatus" style="font-size:13px;color:#666;"></span>
          </div>

          <div class="btn-row">
            <button class="btn btn-gold btn-lg" id="step1Next" onclick="goStep(2)" disabled>
              Next: Upload Excel â†’
            </button>
          </div>
        </div>

        <!-- â•â•â•â•â•â• STEP 2: UPLOAD EXCEL â•â•â•â•â•â• -->
        <div class="panel" id="panel2">
          <div class="sec-hdr">
            <span class="sec-num">2</span>
            <span class="sec-ttl">UPLOAD YOUR EXCEL FILE</span>
          </div>

          <div class="info-box blue">
            <strong>Your Excel file must follow this exact column order:</strong><br>
            &nbsp;&nbsp;&nbsp;â€¢ <strong>Column A:</strong> Organisation Unit Name &nbsp;(must exactly match DHIS2 org unit names at the selected level)<br>
            &nbsp;&nbsp;&nbsp;â€¢ <strong>Column B:</strong> Period in <strong>YYYYMM</strong> format &nbsp;&nbsp;e.g. <code style="background:#dde;padding:1px 6px;border-radius:3px;font-size:11px;">202301</code> = January 2023<br>
            &nbsp;&nbsp;&nbsp;â€¢ <strong>Column C onward:</strong> Data values &nbsp;â€” column <em>headers</em> must match the dataset's data element names<br>
            <br>
            No column selection or mapping is needed â€” everything is matched automatically.
          </div>

          <div class="dz" id="dropZone">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileInput(event)">
            <div class="dz-ico">ğŸ“Š</div>
            <div class="dz-ttl">Drop your Excel file here or click to browse</div>
            <div class="dz-sub">.xlsx &nbsp;Â·&nbsp; .xls &nbsp;Â·&nbsp; .csv</div>
            <div id="fileBadge" style="display:none;justify-content:center;">
              <div class="file-badge">
                <span id="fileNameSpan"></span>
                <button class="rm-btn" onclick="clearFile(event)">Ã—</button>
              </div>
            </div>
          </div>

          <div id="sheetControls" style="display:none;margin-top:16px;">
            <div class="fr" style="max-width:480px;">
              <div class="fg">
                <label class="fl">Sheet</label>
                <select class="fi" id="sheetSel" onchange="reloadSheet()"></select>
              </div>
              <div class="fg">
                <label class="fl">Header Row #</label>
                <input type="number" class="fi" id="hdrRowNum" value="1" min="1" max="30" onchange="reloadSheet()">
              </div>
            </div>
            <div id="fileInfo" style="font-size:13px;color:#666;margin:8px 0;"></div>
            <div class="tbl-wrap" style="max-height:170px;">
              <table class="tbl" id="rawPreviewTable"></table>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-outline" onclick="goStep(1)">â† Back</button>
            <button class="btn btn-gold btn-lg" id="step2Next" onclick="runReview()" disabled>
              Next: Review â†’
            </button>
          </div>
        </div>

        <!-- â•â•â•â•â•â• STEP 3: REVIEW â•â•â•â•â•â• -->
        <div class="panel" id="panel3">
          <div class="sec-hdr">
            <span class="sec-num">3</span>
            <span class="sec-ttl">REVIEW &amp; VALIDATE</span>
          </div>

          <div class="stats" id="reviewStats"></div>
          <div id="reviewMessage"></div>

          <!-- Column matching -->
          <div style="margin:18px 0 10px;">
            <div style="font-weight:700;color:#004080;font-size:13px;border-bottom:2px solid #004080;padding-bottom:6px;margin-bottom:8px;">
              Excel Column Headers â†’ DHIS2 Data Elements (auto-matched)
            </div>
            <div class="tbl-wrap">
              <table class="tbl">
                <thead>
                  <tr><th>Excel Column Header</th><th>Matched DHIS2 Data Element</th><th>Status</th></tr>
                </thead>
                <tbody id="colMatchTbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Org unit matching -->
          <div style="margin:18px 0 10px;">
            <div style="font-weight:700;color:#004080;font-size:13px;border-bottom:2px solid #004080;padding-bottom:6px;margin-bottom:8px;">
              Excel Org Unit Names â†’ DHIS2 UIDs (first 30 shown)
            </div>
            <div class="tbl-wrap">
              <table class="tbl">
                <thead>
                  <tr><th>Excel Name (Column A)</th><th>Matched DHIS2 Org Unit</th><th>Status</th></tr>
                </thead>
                <tbody id="ouMatchTbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Data preview -->
          <div style="margin:18px 0 10px;">
            <div style="font-weight:700;color:#28a745;font-size:13px;border-bottom:2px solid #28a745;padding-bottom:6px;margin-bottom:8px;">
              Data Preview â€” first 15 rows that will be uploaded
            </div>
            <div class="tbl-wrap">
              <table class="tbl" id="previewTable"></table>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-outline" onclick="goStep(2)">â† Back</button>
            <button class="btn btn-gold btn-lg" id="step3Next" onclick="goStep(4)" disabled>
              Next: Push to DHIS2 â†’
            </button>
          </div>
        </div>

        <!-- â•â•â•â•â•â• STEP 4: PUSH â•â•â•â•â•â• -->
        <div class="panel" id="panel4">
          <div class="sec-hdr">
            <span class="sec-num">4</span>
            <span class="sec-ttl">PUSH DATA TO DHIS2</span>
          </div>

          <div class="fr" style="max-width:650px;margin-bottom:16px;">
            <div class="fg">
              <label class="fl">Import Strategy</label>
              <select class="fi" id="stratSel">
                <option value="CREATE_AND_UPDATE">CREATE_AND_UPDATE (Recommended)</option>
                <option value="CREATE">CREATE only (new data only)</option>
                <option value="UPDATE">UPDATE only (existing data only)</option>
              </select>
            </div>
            <div class="fg">
              <label class="fl">Batch Size (rows per request)</label>
              <select class="fi" id="batchSel">
                <option value="100">100 rows</option>
                <option value="250" selected>250 rows</option>
                <option value="500">500 rows</option>
                <option value="1000">1000 rows</option>
              </select>
            </div>
          </div>

          <div class="tog-row">
            <input type="checkbox" id="dryRunChk">
            <label for="dryRunChk">ğŸ§ª Dry Run â€” validate without saving anything to DHIS2</label>
          </div>
          <div class="tog-row">
            <input type="checkbox" id="skipAuditChk">
            <label for="skipAuditChk">âš¡ Skip Audit Log (faster upload)</label>
          </div>

          <div class="stats" id="pushStats" style="margin-top:16px;"></div>

          <div class="prog-wrap" id="progressWrap">
            <div class="prog-top">
              <strong style="color:#004080;font-size:13px;">Upload Progress</strong>
              <span id="progLabel" style="font-size:12px;color:#666;"></span>
            </div>
            <div class="prog-bar">
              <div class="prog-fill" id="progFill" style="width:0%">0%</div>
            </div>
            <div class="log-box" id="logBox"></div>
          </div>

          <div id="pushResult" style="display:none;margin-top:14px;"></div>

          <div class="btn-row" style="justify-content:center;">
            <button class="btn btn-outline" onclick="goStep(3)">â† Back</button>
            <button class="btn btn-green btn-lg" id="pushBtn" onclick="doPush()">ğŸš€ UPLOAD TO DHIS2</button>
            <button class="btn btn-outline-red" onclick="resetAll()">Reset All</button>
          </div>
        </div>

      </div><!-- /card-inner -->
    </div><!-- /card -->

    <div class="footer">
      <p style="font-weight:700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
      <p>Driving Data-Driven Solutions for Health and Development</p>
      <p style="font-size:10px;">Â© 2025 ICF-SL. All rights reserved.</p>
    </div>

  </div><!-- /wrap -->
</div><!-- /main -->

<div class="notif" id="notifDiv"></div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  PROXY URL â€” after deploying Code.gs as a GAS Web App,   â•‘
// â•‘  paste your deployment URL here and save this file.      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXY_URL = 'PASTE_YOUR_GAS_WEB_APP_URL_HERE';

// â”€â”€â”€ Runtime state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let DHIS2_BASE = '';
let AUTH_HEADER = '';

let allDatasets   = [];
let allLevels     = [];
let allOrgUnits   = [];   // at the selected level
let defaultCocId  = '';
let selectedDS    = null;
let selectedLevel = null;

let workbook     = null;
let excelHeaders = [];
let excelRows    = [];

let columnMappings = [];  // [{colIndex, header, deId, deName, matched}]
let orgUnitMap     = {};  // excel name â†’ {id, displayName} | null
let uploadPayload  = [];  // [{dataElement, period, orgUnit, categoryOptionCombo, value}]

// â”€â”€â”€ Proxy helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function proxyGet(dhis2Path) {
  const targetURL = DHIS2_BASE + dhis2Path;
  const requestURL = PROXY_URL
    + '?url='  + encodeURIComponent(targetURL)
    + '&auth=' + encodeURIComponent(AUTH_HEADER);

  const response = await fetch(requestURL);
  const text = await response.text();

  if (!text || text.trim() === '') {
    throw new Error('Empty response from proxy (GET ' + dhis2Path + ')');
  }
  if (text.trim()[0] === '<') {
    throw new Error('Proxy returned HTML instead of JSON. Check your GAS URL and deployment settings.');
  }

  const json = JSON.parse(text);

  if (json.error) {
    throw new Error(json.message || json.dhis2Message || 'Proxy GET error');
  }
  return json;
}

async function proxyPost(dhis2Path, bodyObject) {
  const targetURL = DHIS2_BASE + dhis2Path;

  const response = await fetch(PROXY_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify({
      url:     targetURL,
      auth:    AUTH_HEADER,
      payload: bodyObject
    })
  });

  const text = await response.text();

  if (!text || text.trim() === '') {
    throw new Error('Empty response from proxy (POST ' + dhis2Path + ')');
  }
  if (text.trim()[0] === '<') {
    throw new Error('Proxy POST returned HTML. Ensure Code.gs has doPost() and is deployed correctly.');
  }

  const json = JSON.parse(text);

  if (json.error) {
    throw new Error(json.message || 'Proxy POST error');
  }
  return json;
}

// â”€â”€â”€ Notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function notify(message, type) {
  const el = document.getElementById('notifDiv');
  el.textContent = message;
  el.className = 'notif ' + (type || 'info');
  clearTimeout(el._timer);
  el._timer = setTimeout(function() { el.className = 'notif'; }, 5500);
}

// â”€â”€â”€ Log / Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addLog(message, type) {
  const box  = document.getElementById('logBox');
  const line = document.createElement('div');
  line.className = 'log-line ' + (type || 'info');
  line.textContent = '[' + new Date().toLocaleTimeString() + ']  ' + message;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

function clearLog() { document.getElementById('logBox').innerHTML = ''; }

function setProgress(pct) {
  const fill = document.getElementById('progFill');
  fill.style.width = pct + '%';
  fill.textContent = pct + '%';
  document.getElementById('progLabel').textContent = pct + '% complete';
}

function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function normalise(str) {
  return String(str || '').toLowerCase().replace(/\s+/g, ' ').trim();
}

function parsePeriodYYYYMM(rawValue) {
  var v = String(rawValue || '').trim();
  // Already YYYYMM  e.g.  202301
  if (/^\d{6}$/.test(v)) return v;
  // YYYY-MM  e.g.  2023-01
  var m = v.match(/^(\d{4})-(\d{2})$/);
  if (m) return m[1] + m[2];
  // Yearly  e.g.  2023
  if (/^\d{4}$/.test(v)) return v;
  // Quarterly  e.g.  2023Q1
  if (/^\d{4}Q[1-4]$/i.test(v)) return v.toUpperCase();
  return null;
}

// â”€â”€â”€ Step navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function goStep(n) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('panel' + n).classList.add('active');
  document.querySelectorAll('.tab').forEach(function(tab, i) {
    tab.classList.remove('active', 'done');
    if (i + 1 === n)      tab.classList.add('active');
    else if (i + 1 < n)   tab.classList.add('done');
  });
}

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  if (!PROXY_URL || PROXY_URL === 'PASTE_YOUR_GAS_WEB_APP_URL_HERE') {
    alert(
      'ERROR: The PROXY_URL is not set.\n\n' +
      'Open this HTML file in a text editor.\n' +
      'Find the line near the top of the <script>:\n\n' +
      '  const PROXY_URL = \'PASTE_YOUR_GAS_WEB_APP_URL_HERE\';\n\n' +
      'Replace it with your Google Apps Script Web App URL, then save the file and reload.'
    );
    return;
  }

  DHIS2_BASE  = document.getElementById('instanceUrl').value.trim().replace(/\/+$/, '');
  var user    = document.getElementById('username').value.trim();
  var pass    = document.getElementById('password').value;
  AUTH_HEADER = 'Basic ' + btoa(user + ':' + pass);

  var btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Connecting...';

  try {
    var me = await proxyGet('/api/me');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainDiv').classList.add('active');
    notify('Connected! Welcome ' + (me.firstName || '') + ' ' + (me.surname || ''), 'success');
  } catch (err) {
    notify('Connection failed: ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ”— Connect to DHIS2';
  }
});

// â”€â”€â”€ STEP 1: LOAD METADATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadMeta() {
  var btn = document.getElementById('loadMetaBtn');
  var msg = document.getElementById('metaStatus');
  btn.disabled = true; btn.textContent = 'â³ Loading...';
  msg.textContent = '';

  try {
    notify('Loading DHIS2 metadata...', 'info');

    var results = await Promise.all([
      proxyGet('/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name]]&paging=false'),
      proxyGet('/api/organisationUnitLevels.json?fields=id,level,displayName&paging=false&order=level:asc'),
      proxyGet('/api/categoryOptionCombos.json?fields=id,displayName,name&paging=false')
    ]);

    allDatasets = results[0].dataSets || [];
    allLevels   = results[1].organisationUnitLevels || [];
    var cocs    = results[2].categoryOptionCombos || [];

    var defCoc  = cocs.find(function(c) { return /default/i.test(c.displayName || c.name); }) || cocs[0];
    defaultCocId = defCoc ? defCoc.id : '';

    // Fill datasets dropdown
    var dsSel = document.getElementById('dsSel');
    dsSel.innerHTML = '<option value="">-- Select a dataset --</option>' +
      allDatasets.map(function(ds) {
        return '<option value="' + ds.id + '">' + esc(ds.displayName || ds.name) + '</option>';
      }).join('');

    // Fill org unit levels dropdown
    var lvlSel = document.getElementById('lvlSel');
    lvlSel.innerHTML = '<option value="">-- Select a level --</option>' +
      allLevels.map(function(l) {
        return '<option value="' + l.level + '">' + esc(l.displayName) + ' (Level ' + l.level + ')</option>';
      }).join('');

    msg.innerHTML = '<span style="color:#28a745;font-weight:700;">' +
      'âœ“ ' + allDatasets.length + ' datasets &nbsp;Â·&nbsp; ' +
      allLevels.length + ' org unit levels &nbsp;Â·&nbsp; ' +
      cocs.length + ' category option combos loaded</span>';

    notify('Metadata loaded successfully', 'success');

  } catch (err) {
    msg.innerHTML = '<span style="color:#dc3545;">âœ— ' + esc(err.message) + '</span>';
    notify('Failed to load metadata: ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ”„ Load Datasets & Org Unit Levels';
  }
}

function onDatasetChange() {
  var id = document.getElementById('dsSel').value;
  selectedDS = id ? allDatasets.find(function(d) { return d.id === id; }) : null;

  var hint = document.getElementById('dsHint');
  if (selectedDS) {
    var deList = (selectedDS.dataSetElements || []).map(function(e) { return e.dataElement; });
    hint.style.display = 'block';
    hint.innerHTML =
      '<strong>' + deList.length + ' data elements</strong> Â· Period type: ' + (selectedDS.periodType || 'N/A') +
      '<br>Sample: ' + deList.slice(0, 3).map(function(d) { return esc(d.displayName || d.name); }).join(', ') +
      (deList.length > 3 ? ' ...' : '');
  } else {
    hint.style.display = 'none';
  }
  checkStep1Ready();
}

function onLevelChange() {
  var v = document.getElementById('lvlSel').value;
  selectedLevel = v ? allLevels.find(function(l) { return l.level == parseInt(v); }) : null;

  var row = document.getElementById('ouLoadRow');
  row.style.display = selectedLevel ? 'flex' : 'none';
  allOrgUnits = [];
  document.getElementById('ouStatus').textContent = '';
  checkStep1Ready();
}

async function loadOrgUnits() {
  if (!selectedLevel) return;

  var btn = document.getElementById('ouBtn');
  var msg = document.getElementById('ouStatus');
  btn.disabled = true; btn.textContent = 'â³ Loading org units...';

  try {
    var data = await proxyGet(
      '/api/organisationUnits.json?fields=id,displayName,name&level=' +
      selectedLevel.level + '&paging=false'
    );
    allOrgUnits = data.organisationUnits || [];

    msg.innerHTML = '<span style="color:#28a745;font-weight:700;">' +
      'âœ“ ' + allOrgUnits.length + ' org units loaded at Level ' + selectedLevel.level + '</span>';
    notify('Loaded ' + allOrgUnits.length + ' org units', 'success');
    checkStep1Ready();

  } catch (err) {
    msg.innerHTML = '<span style="color:#dc3545;">âœ— ' + esc(err.message) + '</span>';
    notify('Failed to load org units: ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ“ Load Org Units at Selected Level';
  }
}

function checkStep1Ready() {
  var ready = selectedDS && selectedLevel && allOrgUnits.length > 0;
  document.getElementById('step1Next').disabled = !ready;
}

// â”€â”€â”€ STEP 2: FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var dzEl = document.getElementById('dropZone');
dzEl.addEventListener('dragover',  function(e) { e.preventDefault(); dzEl.classList.add('over'); });
dzEl.addEventListener('dragleave', function()  { dzEl.classList.remove('over'); });
dzEl.addEventListener('drop',      function(e) {
  e.preventDefault(); dzEl.classList.remove('over');
  if (e.dataTransfer.files[0]) readExcelFile(e.dataTransfer.files[0]);
});

function handleFileInput(e) {
  if (e.target.files[0]) readExcelFile(e.target.files[0]);
}

function clearFile(e) {
  e.stopPropagation();
  workbook = null; excelHeaders = []; excelRows = [];
  document.getElementById('fileBadge').style.display = 'none';
  document.getElementById('sheetControls').style.display = 'none';
  document.getElementById('fileInput').value = '';
  document.getElementById('step2Next').disabled = true;
}

function readExcelFile(file) {
  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array', cellDates: false, raw: false });
      document.getElementById('fileNameSpan').textContent = file.name + '  (' + (file.size / 1024).toFixed(1) + ' KB)';
      document.getElementById('fileBadge').style.display = 'flex';

      var sheetSel = document.getElementById('sheetSel');
      sheetSel.innerHTML = workbook.SheetNames.map(function(name, i) {
        return '<option value="' + i + '">' + esc(name) + '</option>';
      }).join('');

      document.getElementById('sheetControls').style.display = 'block';
      reloadSheet();
      notify('File loaded: ' + file.name, 'success');
    } catch (err) {
      notify('Could not read file: ' + err.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

function reloadSheet() {
  if (!workbook) return;

  var sheetIndex = parseInt(document.getElementById('sheetSel').value) || 0;
  var headerRow  = Math.max(1, parseInt(document.getElementById('hdrRowNum').value) || 1);
  var sheet      = workbook.Sheets[workbook.SheetNames[sheetIndex]];
  var rawData    = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });

  if (rawData.length < headerRow) {
    notify('The file has fewer rows than the specified header row number', 'error');
    return;
  }

  excelHeaders = (rawData[headerRow - 1] || []).map(function(h) { return String(h).trim(); });
  excelRows    = rawData.slice(headerRow).filter(function(row) {
    return row.some(function(cell) { return cell !== '' && cell !== null && cell !== undefined; });
  });

  document.getElementById('fileInfo').textContent =
    excelRows.length + ' data rows  Â·  ' + excelHeaders.length + ' columns';

  renderRawPreview();
  document.getElementById('step2Next').disabled = (excelRows.length === 0 || excelHeaders.length < 3);
}

function renderRawPreview() {
  var html = '<thead><tr><th>#</th>' +
    excelHeaders.map(function(h) { return '<th>' + esc(h) + '</th>'; }).join('') +
    '</tr></thead><tbody>';

  excelRows.slice(0, 5).forEach(function(row, i) {
    html += '<tr><td style="color:#aaa;font-size:11px;">' + (i + 1) + '</td>' +
      excelHeaders.map(function(_, ci) {
        var v = (row[ci] !== null && row[ci] !== undefined) ? String(row[ci]) : '';
        return '<td class="' + (v ? 'val-ok' : 'val-empty') + '">' + (esc(v) || 'â€“') + '</td>';
      }).join('') + '</tr>';
  });

  html += '</tbody>';
  document.getElementById('rawPreviewTable').innerHTML = html;
}

// â”€â”€â”€ STEP 3: REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function findDataElement(headerText, dataElements) {
  var h = normalise(headerText);

  // 1. Exact match
  var match = dataElements.find(function(de) {
    return normalise(de.displayName || de.name) === h;
  });
  if (match) return match;

  // 2. One contains the other
  match = dataElements.find(function(de) {
    var n = normalise(de.displayName || de.name);
    return n.includes(h) || h.includes(n);
  });
  return match || null;
}

function runReview() {
  if (!selectedDS || !allOrgUnits.length || !excelRows.length) {
    notify('Please complete steps 1 and 2 first', 'error');
    return;
  }

  var dataElements = (selectedDS.dataSetElements || []).map(function(e) { return e.dataElement; });

  // â”€â”€ A. Match column headers (C onwards) to data elements â”€â”€
  columnMappings = [];
  for (var i = 2; i < excelHeaders.length; i++) {
    var header = excelHeaders[i];
    var de     = findDataElement(header, dataElements);
    columnMappings.push({
      colIndex: i,
      header:   header,
      deId:     de ? de.id   : null,
      deName:   de ? (de.displayName || de.name) : null,
      matched:  !!de
    });
  }

  // â”€â”€ B. Build org unit lookup from the loaded list â”€â”€
  var ouLookupByName = {};
  allOrgUnits.forEach(function(ou) {
    ouLookupByName[normalise(ou.displayName || ou.name)] = ou;
  });

  // Unique names from column A
  var seen = {};
  orgUnitMap = {};
  excelRows.forEach(function(row) {
    var name = String(row[0] || '').trim();
    if (name && !seen[name]) {
      seen[name] = true;
      orgUnitMap[name] = ouLookupByName[normalise(name)] || null;
    }
  });

  // â”€â”€ C. Build upload payload â”€â”€
  uploadPayload = [];
  var matchedColumns = columnMappings.filter(function(c) { return c.matched; });
  var skippedRowCount = 0;

  excelRows.forEach(function(row) {
    var ouName = String(row[0] || '').trim();
    var perRaw = String(row[1] || '').trim();
    var ouObj  = orgUnitMap[ouName];
    var period = parsePeriodYYYYMM(perRaw);

    if (!ouObj || !period) { skippedRowCount++; return; }

    matchedColumns.forEach(function(mc) {
      var v = row[mc.colIndex];
      if (v === '' || v === null || v === undefined) return;
      uploadPayload.push({
        dataElement:        mc.deId,
        period:             period,
        orgUnit:            ouObj.id,
        categoryOptionCombo: defaultCocId,
        value:              String(v)
      });
    });
  });

  // â”€â”€ D. Render column match table â”€â”€
  var colHtml;
  if (columnMappings.length === 0) {
    colHtml = '<tr><td colspan="3" style="color:#999;padding:14px;text-align:center;">No data element columns found. Need at least 3 columns: Org Unit, Period, Data.</td></tr>';
  } else {
    colHtml = columnMappings.map(function(c) {
      return '<tr>' +
        '<td><strong>' + esc(c.header) + '</strong></td>' +
        '<td>' + (c.matched ? esc(c.deName) : '<em style="color:#aaa;">No match found</em>') + '</td>' +
        '<td><span class="badge ' + (c.matched ? 'ok' : 'skip') + '">' + (c.matched ? 'MATCHED âœ“' : 'SKIPPED') + '</span></td>' +
        '</tr>';
    }).join('');
  }
  document.getElementById('colMatchTbody').innerHTML = colHtml;

  // â”€â”€ E. Render org unit match table â”€â”€
  var ouEntries = Object.entries(orgUnitMap).slice(0, 30);
  var ouHtml;
  if (ouEntries.length === 0) {
    ouHtml = '<tr><td colspan="3" style="color:#999;padding:14px;text-align:center;">No org unit names found in column A</td></tr>';
  } else {
    ouHtml = ouEntries.map(function(pair) {
      var name  = pair[0];
      var match = pair[1];
      return '<tr>' +
        '<td>' + esc(name) + '</td>' +
        '<td>' + (match ? esc(match.displayName) : '<em style="color:#aaa;">â€”</em>') + '</td>' +
        '<td><span class="badge ' + (match ? 'ok' : 'warn') + '">' + (match ? 'MATCHED âœ“' : 'NOT FOUND') + '</span></td>' +
        '</tr>';
    }).join('');
  }
  document.getElementById('ouMatchTbody').innerHTML = ouHtml;

  // â”€â”€ F. Stats â”€â”€
  var matchedDE   = columnMappings.filter(function(c) { return c.matched; }).length;
  var skippedDE   = columnMappings.filter(function(c) { return !c.matched; }).length;
  var matchedOU   = Object.values(orgUnitMap).filter(Boolean).length;
  var unmatchedOU = Object.values(orgUnitMap).filter(function(v) { return !v; }).length;
  var periodList  = Array.from(new Set(uploadPayload.map(function(v) { return v.period; })));

  document.getElementById('reviewStats').innerHTML =
    '<div class="stat blue"><div class="stat-n">' + uploadPayload.length + '</div><div class="stat-l">Values Ready</div></div>' +
    '<div class="stat ' + (matchedDE > 0 ? 'green' : 'red') + '"><div class="stat-n">' + matchedDE + '</div><div class="stat-l">DE Cols Matched</div></div>' +
    '<div class="stat ' + (skippedDE > 0 ? 'gold' : 'green') + '"><div class="stat-n">' + skippedDE + '</div><div class="stat-l">DE Cols Skipped</div></div>' +
    '<div class="stat ' + (matchedOU > 0 ? 'green' : 'red') + '"><div class="stat-n">' + matchedOU + '</div><div class="stat-l">OUs Matched</div></div>' +
    '<div class="stat ' + (unmatchedOU > 0 ? 'red' : 'green') + '"><div class="stat-n">' + unmatchedOU + '</div><div class="stat-l">OUs Not Found</div></div>' +
    '<div class="stat"><div class="stat-n">' + periodList.length + '</div><div class="stat-l">Periods</div></div>' +
    '<div class="stat ' + (skippedRowCount > 0 ? 'gold' : '') + '"><div class="stat-n">' + skippedRowCount + '</div><div class="stat-l">Rows Skipped</div></div>';

  // â”€â”€ G. Message â”€â”€
  var msgEl = document.getElementById('reviewMessage');
  if (uploadPayload.length === 0) {
    msgEl.innerHTML = '<div class="info-box red"><strong>â›” No uploadable values found.</strong> ' +
      'Check: (1) Column A has org unit names that exist in DHIS2 at the selected level. ' +
      '(2) Column B has periods in YYYYMM format (e.g. 202301). ' +
      '(3) Column headers from Column C match your dataset\'s data element names.</div>';
  } else if (unmatchedOU > 0 || skippedDE > 0) {
    msgEl.innerHTML = '<div class="info-box yellow"><strong>âš  Partial match.</strong> ' +
      unmatchedOU + ' org unit(s) not found in DHIS2 and ' +
      skippedDE + ' column(s) did not match any data element. Those rows/columns will not be uploaded.</div>';
  } else {
    msgEl.innerHTML = '<div class="info-box green"><strong>âœ… Everything matched perfectly.</strong> ' +
      uploadPayload.length + ' values are ready to upload to DHIS2.</div>';
  }

  // â”€â”€ H. Preview table â”€â”€
  var deCols = columnMappings.filter(function(c) { return c.matched; });
  var previewHtml = '<thead><tr><th>#</th><th>Org Unit</th><th>Period</th>' +
    deCols.map(function(c) { return '<th>' + esc(c.deName) + '</th>'; }).join('') +
    '</tr></thead><tbody>';

  excelRows.slice(0, 15).forEach(function(row, i) {
    var ouName = String(row[0] || '').trim();
    var perRaw = String(row[1] || '').trim();
    var ouObj  = orgUnitMap[ouName];
    var period = parsePeriodYYYYMM(perRaw);

    previewHtml += '<tr>' +
      '<td style="color:#aaa;font-size:11px;">' + (i + 1) + '</td>' +
      '<td class="' + (ouObj ? 'val-ok' : 'val-empty') + '">' +
        (ouObj ? esc(ouObj.displayName) : 'âœ— ' + esc(ouName)) +
      '</td>' +
      '<td class="' + (period ? 'val-ok' : 'val-empty') + '">' + (period || esc(perRaw)) + '</td>' +
      deCols.map(function(mc) {
        var v = row[mc.colIndex];
        var s = (v !== '' && v !== null && v !== undefined) ? esc(String(v)) : '';
        return '<td class="' + (s ? 'val-ok' : 'val-empty') + '">' + (s || 'â€“') + '</td>';
      }).join('') +
      '</tr>';
  });
  previewHtml += '</tbody>';
  document.getElementById('previewTable').innerHTML = previewHtml;

  document.getElementById('step3Next').disabled = uploadPayload.length === 0;
  goStep(3);
  notify(
    uploadPayload.length > 0 ? 'Review complete: ' + uploadPayload.length + ' values ready' : 'No matching values found â€” check your data',
    uploadPayload.length > 0 ? 'success' : 'error'
  );
}

// â”€â”€â”€ STEP 4: PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function doPush() {
  if (!uploadPayload.length) { notify('Nothing to upload', 'error'); return; }

  var btn = document.getElementById('pushBtn');
  btn.disabled = true; btn.textContent = 'â³ Uploading...';
  document.getElementById('progressWrap').classList.add('active');
  document.getElementById('pushResult').style.display = 'none';
  clearLog(); setProgress(0);

  var strategy  = document.getElementById('stratSel').value;
  var batchSize = parseInt(document.getElementById('batchSel').value);
  var dryRun    = document.getElementById('dryRunChk').checked;
  var skipAudit = document.getElementById('skipAuditChk').checked;

  // Split into batches
  var batches = [];
  for (var i = 0; i < uploadPayload.length; i += batchSize) {
    batches.push(uploadPayload.slice(i, i + batchSize));
  }

  var imported = 0, updated = 0, ignored = 0, batchErrors = 0;

  addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
  addLog('DHIS2 BULK UPLOAD STARTING', 'info');
  addLog('Dataset  : ' + (selectedDS.displayName || selectedDS.name), 'info');
  addLog('Strategy : ' + strategy + (dryRun ? '  [DRY RUN â€” nothing will be saved]' : ''), 'info');
  addLog('Values   : ' + uploadPayload.length + '  in  ' + batches.length + ' batch(es) of ' + batchSize, 'info');
  addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

  document.getElementById('pushStats').innerHTML =
    '<div class="stat blue"><div class="stat-n">' + uploadPayload.length + '</div><div class="stat-l">Total Values</div></div>' +
    '<div class="stat"><div class="stat-n">' + batches.length + '</div><div class="stat-l">Batches</div></div>' +
    (dryRun ? '<div class="stat gold"><div class="stat-n">DRY</div><div class="stat-l">Dry Run Mode</div></div>' : '');

  for (var b = 0; b < batches.length; b++) {
    var batch = batches[b];
    setProgress(Math.round((b / batches.length) * 90));
    addLog('Batch ' + (b + 1) + ' / ' + batches.length + '  â†’  sending ' + batch.length + ' values...', 'info');

    try {
      var qs = '/api/dataValueSets?importStrategy=' + strategy + '&dryRun=' + dryRun;
      if (skipAudit) qs += '&skipAudit=true';

      var result = await proxyPost(qs, { dataValues: batch });

      var ic  = result.importCount || (result.response && result.response.importCount) || {};
      var imp = ic.imported || 0;
      var upd = ic.updated  || 0;
      var ign = ic.ignored  || 0;
      imported += imp; updated += upd; ignored += ign;

      addLog(
        'Batch ' + (b + 1) + '  âœ“ ' + imp + ' imported   â†‘ ' + upd + ' updated   âœ— ' + ign + ' ignored',
        ign > 0 ? 'warning' : 'success'
      );

      // Show DHIS2 conflict details (first 3)
      var conflicts = result.conflicts || (result.response && result.response.conflicts) || [];
      conflicts.slice(0, 3).forEach(function(c) {
        addLog('    â†³ ' + (c.value || c.object || JSON.stringify(c)), 'warning');
      });

    } catch (err) {
      addLog('Batch ' + (b + 1) + ' FAILED: ' + err.message, 'error');
      batchErrors += batch.length;
    }

    if (b < batches.length - 1) await sleep(250);
  }

  setProgress(100);
  var success = imported + updated > 0;

  addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', success ? 'success' : 'warning');
  addLog((dryRun ? 'DRY RUN ' : '') + 'UPLOAD COMPLETE', success ? 'success' : 'warning');
  addLog('Imported: ' + imported + '   Updated: ' + updated + '   Ignored: ' + ignored + '   Batch errors: ' + batchErrors, success ? 'success' : 'warning');
  addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', success ? 'success' : 'warning');

  document.getElementById('pushStats').innerHTML =
    '<div class="stat ' + (imported > 0 ? 'green' : '') + '"><div class="stat-n">' + imported + '</div><div class="stat-l">Imported</div></div>' +
    '<div class="stat ' + (updated  > 0 ? 'green' : '') + '"><div class="stat-n">' + updated  + '</div><div class="stat-l">Updated</div></div>' +
    '<div class="stat ' + (ignored  > 0 ? 'red'   : '') + '"><div class="stat-n">' + ignored  + '</div><div class="stat-l">Ignored</div></div>' +
    '<div class="stat ' + (batchErrors > 0 ? 'red' : 'green') + '"><div class="stat-n">' + batchErrors + '</div><div class="stat-l">Batch Errors</div></div>';

  var resEl = document.getElementById('pushResult');
  resEl.style.display = 'block';
  resEl.innerHTML = '<div class="info-box ' + (success ? 'green' : 'yellow') + '">' +
    '<strong>' + (dryRun ? 'ğŸ§ª Dry Run Complete' : (success ? 'âœ… Upload Successful!' : 'âš  Upload Finished with Issues')) + '</strong><br>' +
    imported + ' imported Â· ' + updated + ' updated' +
    (ignored > 0 ? ' Â· ' + ignored + ' ignored' : '') +
    (batchErrors > 0 ? ' Â· ' + batchErrors + ' batch errors' : '') + '.' +
    (dryRun ? ' No data was actually saved to DHIS2 (dry run mode).' : '') +
    '</div>';

  notify(success ? 'Upload complete!' : 'Finished with issues â€” see log', success ? 'success' : 'warning');
  btn.disabled = false; btn.textContent = 'ğŸš€ UPLOAD TO DHIS2';
}

// â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function resetAll() {
  workbook = null; excelHeaders = []; excelRows = [];
  columnMappings = []; orgUnitMap = {}; uploadPayload = [];
  selectedDS = null; selectedLevel = null; allOrgUnits = [];

  document.getElementById('fileInput').value = '';
  document.getElementById('fileBadge').style.display = 'none';
  document.getElementById('sheetControls').style.display = 'none';
  document.getElementById('step2Next').disabled = true;
  document.getElementById('step1Next').disabled = true;
  document.getElementById('dsSel').value = '';
  document.getElementById('lvlSel').value = '';
  document.getElementById('ouLoadRow').style.display = 'none';
  document.getElementById('ouStatus').textContent = '';
  document.getElementById('dsHint').style.display = 'none';
  document.getElementById('progressWrap').classList.remove('active');
  document.getElementById('pushResult').style.display = 'none';
  document.getElementById('pushStats').innerHTML = '';
  document.getElementById('reviewStats').innerHTML = '';
  document.getElementById('reviewMessage').innerHTML = '';
  goStep(1);
  notify('All selections cleared â€” ready to start again', 'info');
}
</script>
</body>
</html>
